/*------------------------------------------------------
 Company:           Valentys Ltda.
 Author:            David Gaete <dmunozgaete@gmail.com> (https://github.com/dmunozgaete)
 
 Description:       Angular Implementation for the Javascript Client GALE
 Github:            https://github.com/dmunozgaete/angular-gale

 VersiÃ³n:           1.0.0-rc.1
 Build Date:        2015-11-23 11:52:52
------------------------------------------------------*/


!function(angular){var registered_routes=[],getLogger=function(){if(!this.$log){var $injector=angular.injector(["ng"]);this.$log=$injector.get("$log")}return this.$log};Function.prototype.method=function(name,func){return this.prototype[name]=func,this},angular.manifiest=function(bundle,namespaces,dependencies){return angular.forEach(namespaces,function(name){try{angular.module(name)}catch(err){angular.module(name,dependencies||[])}}),angular.module(bundle,namespaces)},angular.route=function(route,controller,view){var separator="/",parameter_separator="/:",layout_separator=".",logger=getLogger(),default_document="/index";route||logger.error("route value is required");var layout="",module=route.substring(0,route.indexOf(separator)),path=route.substring(route.indexOf(separator)+1),viewName="content";if(view&&view.length>0&&(viewName=view),module.indexOf(layout_separator)>0){var baseParts=module.split(layout_separator);layout=baseParts[0],module=baseParts[1]}var url="/{0}/{1}".format([module,path]),viewPath="views{0}.html".format([url]);if(url.endsWith(default_document)){var regex=new RegExp(default_document,"ig");url=url.replace(regex,""),route=route.replace(regex,"")}route.indexOf(parameter_separator)>=0&&(viewPath=viewPath.substring(0,viewPath.indexOf(parameter_separator))+".html",route=route.substring(0,route.indexOf(parameter_separator)));var config=null;""===layout?config={url:url,templateUrl:viewPath,controller:controller}:(config={url:url,views:{}},config.views[viewName]={templateUrl:viewPath,controller:controller}),registered_routes.push({route:route,config:config})};var format=function(template,values,pattern){return pattern=pattern||/\{([^\{\}]*)\}/g,template.replace(pattern,function(a,b){var p=b.split("."),r=values;try{for(var s in p)r=r[p[s]]}catch(e){r=a}return"string"==typeof r||"number"==typeof r?r:a})},endsWith=function(template,value){return template.match(value+"$")==value},startsWith=function(template,value){return 0===template.indexOf(value)};String.method("format",function(values,pattern){return format(this,values,pattern)}),String.method("endsWith",function(value){return endsWith(this,value)}),String.method("startsWith",function(value){return startsWith(this,value)}),angular.element(document).ready(function(){var application_bundle="App",$injector=angular.injector(["ng","config"]),INITIAL_CONFIGURATION=$injector.get("GLOBAL_CONFIGURATION"),$http=$injector.get("$http"),logger=getLogger(),environment=(INITIAL_CONFIGURATION.application.environment+"").toLowerCase();$http.get("config/env/"+environment+".json").success(function(ENVIRONMENT_CONFIGURATION){var CONFIGURATION=angular.extend(INITIAL_CONFIGURATION,ENVIRONMENT_CONFIGURATION);angular.module(application_bundle).constant("CONFIGURATION",CONFIGURATION);var lang=(INITIAL_CONFIGURATION.application.language+"").toLowerCase();$http.get("config/locale/"+lang+".json").success(function(data){angular.module(application_bundle).constant("RESOURCES",data),angular.module(application_bundle).config(["$stateProvider",function($stateProvider){angular.forEach(registered_routes,function(route){$stateProvider.state(route.route,route.config)}),CONFIGURATION.debugging&&logger.debug("registered routes:",registered_routes),registered_routes=[]}]),angular.bootstrap(document,[application_bundle])}).error(function(){logger.error("Can't get resources file (config/resources/"+lang+".json)")})}).error(function(){logger.error("Can't get configuration file (config/env/"+environment+".json)")})})}(angular),angular.module("gale.templates",[]).run(["$templateCache",function(){"use strict"}]),angular.manifiest("gale",["gale.classes","gale.directives","gale.filters","gale.services","gale.services.security","gale.services.configuration","gale.services.rest","gale.services.storage"],["ui.router"]).run(["$Configuration","$LocalStorage","$log","CONFIGURATION",function($Configuration,$LocalStorage,$log,CONFIGURATION){var stored_key="$_application",app_conf=CONFIGURATION.application,app_stored=$LocalStorage.getObject(stored_key);if(app_stored&&(app_stored.version!==app_conf.version||app_stored.environment!==app_conf.environment)&&($log.debug("a new configuration version is available, calling [on_build_new_version] if exist's !",app_conf.version),angular.isFunction(CONFIGURATION.on_build_new_version)))try{CONFIGURATION.on_build_new_version(app_conf.version,app_stored.version)}catch(e){throw $log.debug("failed to execute [on_build_new_version] function defined in config.js",e),e}$LocalStorage.setObject(stored_key,app_conf)}]),angular.module("gale.classes").factory("BaseEventHandler",function(){var listeners={},self={};return self.$on=function(name,handler){var namedListeners=listeners[name];return namedListeners||(listeners[name]=namedListeners=[]),namedListeners.push(handler),function(){var indexOf=namedListeners.indexOf(handler);indexOf>=0&&(namedListeners[indexOf]=null)}},self.hasEventHandlersFor=function(name){return null!=listeners[name]},self.$fire=function(name,args){if(self.hasEventHandlersFor(name)){var handlers=listeners[name];angular.forEach(handlers,function(handler){handler&&handler.apply(handler,args)})}},self.$clear=function(name){self.hasEventHandlersFor(name)&&delete listeners[name]},self}),angular.module("gale.directives").directive("selectTextOnClick",function(){return{restrict:"A",link:function(scope,element){element.on("click",function(){this.select()})}}}),angular.module("gale.directives").directive("toNumberOnBlur",["$filter","$locale",function($filter){return{require:"ngModel",restrict:"A",link:function(scope,elm,attrs,ctrl){var isReadonly=attrs.readonly;elm.bind("blur",function(){var filter="number";ctrl.$viewValue=$filter(filter)(ctrl.$modelValue),ctrl.$render()}),elm.bind("focus",function(){isReadonly||(ctrl.$viewValue=ctrl.$modelValue,ctrl.$render())}),scope.$watch("ctrl.$modelValue",function(){elm.triggerHandler("blur")})}}}]),angular.module("gale.directives").directive("ngEmail",["$log",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ctrl){var pattern=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;ctrl.$validators.email=function(modelValue,viewValue){return ctrl.$isEmpty(modelValue)?!0:ctrl.$isEmpty(viewValue)?!1:pattern.test(viewValue)}}}}]),angular.module("gale.directives").directive("ngRange",["$log",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ctrl){var min=parseInt(attrs.min),max=parseInt(attrs.max);ctrl.$validators.range=function(modelValue,viewValue){var value=parseInt(viewValue);return ctrl.$isEmpty(modelValue)?!0:ctrl.$isEmpty(viewValue)?!1:isNaN(min)||isNaN(max)?isNaN(min)?isNaN(max)?!0:max>=value?!0:!1:value>=min?!0:!1:value>=min&&max>=value?!0:!1}}}}]),angular.module("gale.directives").directive("ngRut",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){var validaRut=function(rutCompleto){var tmp=[];if(rutCompleto.indexOf("-")>0){if(!/^[0-9]+-[0-9kK]{1}$/.test(rutCompleto))return!1;tmp=rutCompleto.split("-")}else{var rut=rutCompleto.replace("-","");tmp.push(rut.substring(0,rut.length-1)),tmp.push(rut.substring(rut.length-1))}return tmp.length<2?!1:dv(tmp[0])+""==tmp[1].toLowerCase()+""},dv=function(T){for(var M=0,S=1;T;T=Math.floor(T/10))S=(S+T%10*(9-M++%6))%11;return S?S-1:"k"};ctrl.$validators.rut=function(modelValue,viewValue){return ctrl.$isEmpty(modelValue)?!0:ctrl.$isEmpty(viewValue)?!1:validaRut(viewValue)?!0:!1}}}}),angular.module("gale.filters").filter("capitalize",function(){return function(input){return input?input.replace(/([^\W_]+[^\s-]*) */g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()}):""}}),angular.module("gale.filters").filter("localize",["$Localization","$log","$interpolate",function($Localization,$log,$interpolate){return function(text,parameters){try{var template=$Localization.get(text);if(parameters){var exp=$interpolate(template);template=exp({parameters:parameters})}return template}catch(e){return text}}}]),function(){var resourceUrl=function(resource,$Identity){var url=resource;return $Identity.isAuthenticated()&&(url+="&access_token="+$Identity.getAccessToken()),url};angular.module("gale.filters").filter("restricted",["$Api","$Identity",function($Api,$Identity){return function(resource){return resourceUrl(resource,$Identity)}}])}(),angular.module("gale.filters").filter("template",["$log","$interpolate",function($log,$interpolate){return function(template,context){var exp=$interpolate(template),content=exp(context);return content}}]),angular.module("gale.services.configuration").service("$Configuration",["$rootScope","$LocalStorage","CONFIGURATION",function($rootScope,$LocalStorage,CONFIGURATION){function get(name,defaultValue){var v=_values[name];if(void 0===typeof v){if(defaultValue)return defaultValue;throw Error(name+" don't exists in configuration")}return _values[name]}function exists(name){return null!=_values[name]}function set(name,value){_values[name]=value}var _values={};for(var env_name in CONFIGURATION)set(env_name,CONFIGURATION[env_name]);return{get:get,exists:exists}}]),angular.module("gale.services.configuration").service("$Localization",["RESOURCES",function(RESOURCES){function get(name,defaultValue){var v=RESOURCES[name];if("undefined"==typeof v){ns=name.split("."),index=RESOURCES;for(var n in ns)void 0!==index[ns[n]]?(index=index[ns[n]],error=!1):error=!0;if(error){if(defaultValue)return defaultValue;throw Error(name+" don't exists in resources")}return index}return RESOURCES[name]}function exists(name){return null!=RESOURCES[name]}return{get:get,exists:exists}}]),angular.module("gale.services").provider("$Api",function(){var _endpoint=null,EVENTS={BEFORE_SEND:"before-send",SUCCESS:"success",ERROR:"error"};this.setEndpoint=function(endpoint){_endpoint=endpoint},this.$get=["$rootScope","$http","$log","KQLBuilder","$q",function($rootScope,$http,$log,KQLBuilder,$q){var self=this,$$listeners={};self.$on=function(name,listener){var namedListeners=$$listeners[name];return namedListeners||($$listeners[name]=namedListeners=[]),namedListeners.push(listener),function(){namedListeners[indexOf(namedListeners,listener)]=null}};var fire=function(name,args){var listeners=$$listeners[name];listeners&&angular.forEach(listeners,function(listener){listener.apply(listener,args)})};return self.getEndpoint=function(){if(!_endpoint)throw Error("ENDPOINT_NOT_CONFIGURED");return _endpoint},self.parseURI=function(cfg,body){if(cfg.url.indexOf("{")>=0){var parametersToRemove=[];for(var parameter in body){var regex=new RegExp("{"+parameter+"}","g");if(regex.test(cfg.url)){var value=body[parameter];if(!value)throw Error("URI_PARAMETER_UNDEFINED: "+parameter);cfg.url=cfg.url.replace("{"+parameter+"}",value.toString()),parametersToRemove.push(parameter)}}if(angular.forEach(parametersToRemove,function(parameter){delete body[parameter]}),body&&"POST"===cfg.method||"PUT"===cfg.method){var keys=Object.keys(body);if(keys.length>=2)throw Error("RESTFUL_RESTRICTION: ONLY_ONE_PARAMETER_IS_PERMITTED_IN_PAYLOAD");1===keys.length&&(body=body[keys[0]])}}return cfg["GET"===cfg.method?"params":"data"]=body,cfg},self.invoke=function(method,url,body,headers){var defer=$q.defer(),_headers={"Content-Type":"application/json"};if(headers)for(var name in headers)_headers[name]=headers[name];fire(EVENTS.BEFORE_SEND,[_headers,url,body]);var fullURL=self.getEndpoint()+url,regex=/(http|https):\/\//;regex.test(url)&&(fullURL=url);var cfg={url:fullURL,method:method,headers:_headers};self.parseURI(cfg,body),$log.debug("["+method+" "+url+"] parameters: ",body);var http=$http(cfg).success(function(data,status,headers){defer.resolve(data),fire(EVENTS.SUCCESS,[data,status,headers])}).error(function(data,status,headers){defer.reject(data),fire(EVENTS.ERROR,[data,status,headers])});return defer.promise.success=http.success,defer.promise.error=http.error,defer.promise["finally"]=http["finally"],defer.promise},self.kql=function(url,kql,headers){return url=KQLBuilder.build(url,kql),delete kql.select,delete kql.filters,delete kql.limit,delete kql.orderBy,self.invoke("GET",url,kql,headers)},self.create=function(url,body,headers){return self.invoke("POST",url,body,headers)},self.read=function(url,parameters,headers){return self.invoke("GET",url,parameters,headers)},self.update=function(url,body,headers){return self.invoke("PUT",url,body,headers)},self["delete"]=function(url,parameters,headers){return self.invoke("DELETE",url,parameters,headers)},self}]}),angular.module("gale.services").factory("KQLBuilder",function(){var self=this;return self.build=function(endpoint,configuration){var arr=[],builder=[endpoint+"?"];configuration.select&&(builder.push("$select="),arr=[],angular.forEach(function(key){arr.push(key)}),builder.push(arr.join(",")),builder.push("&")),configuration.filters&&(builder.push("$filter="),arr=[],angular.forEach(configuration.filters,function(item){arr.push(item.property+" "+item.operator+" '"+item.value+"'")}),builder.push(arr.join(",")),builder.push("&")),configuration.limit&&(builder.push("$limit="),builder.push(configuration.limit),builder.push("&")),configuration.orderBy&&(builder.push("$orderBy="),builder.push(configuration.orderBy.property),builder.push(" "),builder.push(configuration.orderBy.order),builder.push("&"));var url=builder.join("");return url},this}),angular.module("gale.services").run(["$Identity",function(){}]).provider("$Identity",function(){function getIssuerEndpoint(){if(!_issuerEndpoint)throw Error("ISSUER_ENDPOINT_NOT_SET");return _issuerEndpoint}function getLogInRoute(){if(!_logInRoute)throw Error("LOGINURL_NOT_SET");return _logInRoute}var $ref=this,AUTH_EVENTS={loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"},_issuerEndpoint=null,_logInRoute=null,_enable=!1,_whiteListResolver=function(){return!1};this.setIssuerEndpoint=function(value){return _issuerEndpoint=value,$ref},this.setLogInRoute=function(value){return _logInRoute=value,$ref},this.enable=function(){return _enable=!0,$ref},this.setWhiteListResolver=function(value){if("function"!=typeof value)throw Error("WHITELIST_RESOLVER_FUNCTION_EXPECTED");return _whiteListResolver=value,$ref},this.$get=["$rootScope","$Api","$state","$LocalStorage",function($rootScope,$Api,$state,$LocalStorage){var _token_key="$_identity",_properties={},_authResponse=$LocalStorage.getObject(_token_key),self=this,_login=function(oauthToken){$LocalStorage.setObject(_token_key,oauthToken),_authResponse=oauthToken,$rootScope.$broadcast(AUTH_EVENTS.loginSuccess,oauthToken)},_logout=function(){$LocalStorage.remove(_token_key),_authResponse=null,$rootScope.$broadcast(AUTH_EVENTS.logoutSuccess),$state.go(getLogInRoute())},_addProperty=function(name,value){_properties[name]=value};return self.authenticate=function(credentials){return $Api.invoke("POST",getIssuerEndpoint(),credentials).success(function(data){self.logIn(data)}).error(function(){$rootScope.$broadcast(AUTH_EVENTS.loginFailed)})},self.extend=function(name,value){if("object"!=typeof name)_addProperty(name,value);else for(var key in name)_addProperty(key,name[key])},self.getAccessToken=function(){return _authResponse.access_token},self.getTokenType=function(){return _authResponse.token_type},self.logIn=function(oauthToken){if(!oauthToken.access_token)throw Error("OAUTHTOKEN_BADFORMAT: access_token (jwt)");if(!oauthToken.expires_in)throw Error("OAUTHTOKEN_BADFORMAT: expires_in (unixTime)");if(!oauthToken.token_type)throw Error("OAUTHTOKEN_BADFORMAT: token_type (string)");_login(oauthToken)},self.logOut=function(){_logout()},self.getCurrent=function(){var payload=self.getAccessToken().split(".")[1];if(!atob)throw Error("ATOB_NOT_IMPLEMENTED");return data=decodeURIComponent(escape(atob(payload))),data=JSON.parse(data),data.property=function(name){return _properties[name]},data.isInRole=function(roleName){return _.contains(data.role,roleName)},data},self.isAuthenticated=function(){return null!==_authResponse},_enable&&($Api.$on("before-send",function(headers){if(self.isAuthenticated()){var jwt=_authResponse;headers.Authorization=jwt.token_type+" "+jwt.access_token}}),$Api.$on("error",function(data,status){var _event=null;switch(status){case 401:return void _logout();case 403:_event=AUTH_EVENTS.notAuthorized;break;case 419:case 440:_event=AUTH_EVENTS.sessionTimeout}_event&&$rootScope.$broadcast(_event,data,status)}),$rootScope.$on("$stateChangeStart",function(event,toState,current){self.isAuthenticated()||toState.name===getLogInRoute()||_whiteListResolver(toState,current)||($state.go(getLogInRoute()),event.preventDefault())})),self}]}),angular.module("gale.services").factory("$LocalStorage",["$window",function($window){return{set:function(key,value){$window.localStorage[key]=value},get:function(key,defaultValue){return $window.localStorage[key]||defaultValue},setObject:function(key,value){$window.localStorage[key]=angular.toJson(value)},getObject:function(key){return angular.fromJson($window.localStorage[key]||null)},remove:function(key){$window.localStorage.removeItem(key)},clear:function(){$window.localStorage.clear()},exists:function(){return null!=$window.localStorage[key]}}}]),angular.module("gale.services").factory("$Timer",["$timeout",function($timeout){function Timer(callback,duration,invokeApply){this._callback=callback,this._duration=duration||0,this._invokeApply=invokeApply!==!1,this._timer=null}function timerFactory(callback,duration,invokeApply){return new Timer(callback,duration,invokeApply)}return Timer.prototype={constructor:Timer,isActive:function(){return!!this._timer},restart:function(){this.stop(),this.start()},flush:function(){this._resolveFunction&&this._resolveFunction()},start:function(){var self=this;self._timer&&self.stop(),this._timer=$timeout(function(){try{self._callback.call(null)}finally{self._timer=null}},this._duration,this._invokeApply)},stop:function(){$timeout.cancel(this._timer),this._timer=!1},destroy:function(){this.stop(),this._callback=null,this._duration=null,this._invokeApply=null,this._timer=null}},timerFactory.Timer=Timer,timerFactory}]);
//# sourceMappingURL=angular-gale.min.js.map