angular.manifiest("gale",["gale.directives","gale.components","gale.filters","gale.services","gale.services.security","gale.services.configuration","gale.services.rest","gale.services.storage"]).run(function($Configuration,$LocalStorage,$log,CONFIGURATION){var stored_key="$_application",app_conf=CONFIGURATION.application,app_stored=$LocalStorage.getObject(stored_key);if(app_stored&&(app_stored.version!==app_conf.version||app_stored.environment!==app_conf.environment)&&($log.debug("a new configuration version is available, calling [on_build_new_version] if exist's !",app_conf.version),angular.isFunction(CONFIGURATION.on_build_new_version)))try{CONFIGURATION.on_build_new_version(app_conf.version,app_stored.version)}catch(e){throw $log.debug("failed to execute [on_build_new_version] function defined in config.js",e),e}$LocalStorage.setObject(stored_key,app_conf)}).config(function($mdIconProvider){var bundle_src="bundles/gale/svg/icons/{0}-icons.svg";angular.forEach(["action","alert","av","communication","content","device","editor","file","hardware","icons","image","maps","navigation","notification","social","toggle"],function(toolset){$mdIconProvider.iconSet(toolset,bundle_src.format([toolset]),24)})}),angular.module("gale.components").directive("galeFinder",function(){return{restrict:"E",scope:{onSearch:"=",onSelect:"=",placeholder:"@",minLength:"@",blockUi:"@"},templateUrl:"bundles/gale/js/components/gale-finder/templates/template.html",controller:function($scope,$element,$log,$galeFinder){var self={},minLength=$scope.minLength||3,onSearch=$scope.onSearch,onSelect=$scope.onSelect,blockUi=$scope.blockUi?"true"===$scope.blockUi?!0:!1:!0,body=angular.element(document.body),blocker=null;onSearch||$log.error("undefined 'onSearch' for finder component"),onSelect||$log.error("undefined 'onSelect' for finder component"),$scope.search=function(query){if($scope.activeIndex=0,query.length>=minLength){var promise=onSearch(query);angular.isArray(promise)?$scope.results=items:promise.then(function(items){$scope.results=items})}else $scope.results=[]},$scope.select=function(item){var ret=onSelect(item);ret&&self.hide()},$scope.close=function(){self.hide()},self.hide=function(){$element.removeClass("show"),$scope.query="",$scope.results=[],$scope.activeIndex=0,blocker&&blocker.remove()},self.show=function(){blockUi&&(blocker=angular.element('<md-backdrop class="md-sidenav-backdrop md-opaque ng-scope md-default-theme"></md-backdrop>'),body.append(blocker)),$element.addClass("show"),$element.find("input").focus()},$galeFinder.$$register(self),$scope.$on("$destroy",function(){$galeFinder.$$unregister()});var keys=[];keys.push({code:13,action:function(){if($scope.results.length>0&&$scope.activeIndex>=0){var item=$scope.results[$scope.activeIndex];$scope.select(item)}}}),keys.push({code:38,action:function(){$scope.activeIndex--}}),keys.push({code:40,action:function(){$scope.activeIndex++}}),keys.push({code:27,action:function(){self.hide()}}),$element.bind("keydown",function(event){keys.forEach(function(o){o.code===event.keyCode&&o.action()}),event.stopPropagation()})},link:function(){}}}),angular.module("gale.components").factory("$galeFinder",function(){var self=this,_component=null,_get=function(){if(!_component)throw{message:"no finder has found"};return _component};return self.$$register=function(component){_component=component},self.$$unregister=function(){_component=null},self.show=function(){return _get().show()},self.hide=function(){return _get().hide()},self}),angular.module("gale.components").directive("galeCenter",function(){return{restrict:"E",require:"^galeLoading",scope:{},controller:function(){},link:function(scope,element){element.attr("layout","row"),element.attr("layout-align","start center")}}}),angular.module("gale.components").directive("galeLoading",function(){return{restrict:"E",scope:{defaultMessage:"@"},templateUrl:"bundles/gale/js/components/gale-loading/templates/template.html",controller:function($scope,$element,$log,$galeLoading){var self={},defaultMesasage=$scope.defaultMessage||"";self.hide=function(){$element.removeClass("show")},self.show=function(message){$element.addClass("show");var elm=$element.find("gale-text");elm.html(message?message:defaultMesasage)},$galeLoading.$$register(self),$scope.$on("$destroy",function(){$galeLoading.$$unregister()})},link:function(scope,element){element.attr("layout","row"),element.attr("layout-align","center center")}}}),angular.module("gale.components").factory("$galeLoading",function(){var self=this,_component=null,_get=function(){if(!_component)throw{message:"no gale-loading has found"};return _component};return self.$$register=function(component){_component=component},self.$$unregister=function(){_component=null},self.show=function(message){return _get().show(message)},self.hide=function(){return _get().hide()},self}),angular.module("gale.components").directive("galePage",function(){return{restrict:"E",scope:{title:"@",onKeydown:"="},controller:function($scope){var $window=angular.element(window),onKeyDown=$scope.onKeydown;onKeyDown&&$window.on("keydown",function(event){onKeyDown(event,event.keyCode)}),$scope.$on("$destroy",function(){$window.off("keydown")})},link:function(scope){scope.$emit("gale-page:title:changed",{title:scope.title||" "})}}}),angular.module("gale.components").directive("galeColumn",function(){return{restrict:"E",require:"^galeTable",scope:{title:"@",property:"@",width:"@",align:"@"},transclude:!0,controller:function(){},link:function(scope,element,attrs,galeTable,$transclude){element.attr("flex",scope.width?scope.width:""),element.addClass("gale-column"),$transclude(scope,function(fragments){var header=_.find(fragments,function(elm){return"gale-header"===elm.nodeName.toLowerCase()});if(header){header=angular.element(header);var hscript=header.find("script");if(hscript.length>0)header=hscript;else{var htemplate=header.find("template");htemplate.length>0&&(htemplate=htemplate)}}else header=angular.element("<div>"+(scope.title||"")+"</div>");var cls=null;switch(scope.align){case"left":cls="alignLeft";break;case"right":cls="alignRight";break;case"center":cls="alignCenter"}cls&&header.addClass(cls),element.append(header);var item=_.find(fragments,function(elm){return"gale-item"===elm.nodeName.toLowerCase()});if(item){item=angular.element(item);var script=item.find("script");if(script.length>0)item=script;else{var template=item.find("template");template.length>0&&(item=template)}}else{var html="";scope.property&&(html="{{item."+scope.property+"}}"),item=angular.element("<div>"+html+"</div>")}galeTable.$$formatters.push({property:scope.property,width:scope.width,align:scope.align,template:item.html()})})}}}),angular.module("gale.components").directive("galeItem",function(){return{restrict:"E",require:"^galeTable",compile:function(){},controller:function(){}}}),angular.module("gale.components").directive("galeRow",function($compile){return{restrict:"E",require:"^galeTable",controller:function(){},link:function(scope,element,attrs,ctrl){angular.forEach(scope.$$formatters,function(formatter,$index){var template="<gale-cell class='karma-cell'>"+formatter.template+"</gale-cell>",cell=$compile(template)(scope);cell.attr("flex",formatter.width?formatter.width:"");var cls=null;switch(formatter.align){case"left":cls="alignLeft";break;case"right":cls="alignRight";break;case"center":cls="alignCenter"}cls&&cell.addClass(cls),cell.attr("y",$index),cell.bind("click",function(ev){var $cell=angular.element(this),x=$cell.parent().attr("x"),y=$cell.attr("y");ctrl.$$cellClick(ev,scope.item,y,x)}),element.append(cell)})}}}),angular.module("gale.components").directive("galeTable",function(){return{restrict:"E",scope:{paginate:"@",items:"=",endpoint:"@",showHeader:"@",rowClick:"&",cellClick:"&",name:"@"},transclude:!0,templateUrl:"bundles/gale/js/components/gale-table/templates/template.html",controller:function($scope,$element,$interpolate,$compile,$Api,$galeTable,KQLBuilder){this.$$formatters=$scope.$$formatters=[];var self=this,unique_id=$scope.name||(new Date).getTime(),configuration={},$$listeners={};self.$on=function(name,listener){"row-click"===name&&$element.addClass("row-click");var namedListeners=$$listeners[name];return namedListeners||($$listeners[name]=namedListeners=[]),namedListeners.push(listener),function(){namedListeners[indexOf(namedListeners,listener)]=null}},self.hasEventHandlersFor=function(name){return null!=$$listeners[name]},self.$fire=function(name,args){var listeners=$$listeners[name];listeners&&angular.forEach(listeners,function(listener){listener.apply(listener,args)})},$galeTable.$$register(self,unique_id),self.getUniqueId=function(){return unique_id},self.setup=function(endpoint,cfg){var url=endpoint;cfg&&(url=KQLBuilder.build(url,cfg)),configuration=cfg||{},$scope.endpoint=url},self.bind=function(endpoint){$scope.isLoading=!0,$Api.invoke("GET",endpoint,null,configuration.headers).success(function(data){self.render(data,!0),self.$fire("load-complete",[data,unique_id])})["finally"](function(){$scope.isLoading=!1})},self.render=function(data,isRest){self.$fire("before-render",[data,unique_id]),$scope.source=isRest?data.items:data,isRest&&(data.total=data.items.length)};$scope.cellClick();self.$$cellClick=function(ev,item,cellIndex,rowIndex){self.$fire("cell-click",[ev,item,{x:rowIndex,y:cellIndex},self.getUniqueId()])},$scope.$on("$destroy",function(){$galeTable.$$unregister(self,unique_id)})},link:function(scope,element,attrs,ctrl){var rowClickHandler=scope.rowClick();scope.showHeader&&!scope.$eval(scope.showHeader)&&element.find("gale-header").css("display","none"),element.attr("layout-fill",""),element.addClass("gale-table"),scope.$watch("endpoint",function(value){value&&ctrl.bind(value)}),scope.$watch("items",function(value){value&&ctrl.render(value,!1)}),(rowClickHandler||ctrl.hasEventHandlersFor("row-click"))&&element.addClass("row-click"),scope.onRowClick=function(item){ctrl.$fire("row-click",[event,item,ctrl.getUniqueId()]),rowClickHandler&&rowClickHandler(item)}}}}),angular.module("gale.components").factory("$galeTable",function($q,$rootScope){var self=this,deferred=$q.defer(),components={},$$register=function(component,uniqueID){components[uniqueID]=component},$$unregister=function(component,uniqueID){delete components[uniqueID]},_getByHandle=function(uniqueID){var identifier=uniqueID;if(!identifier){var count=Object.keys(components).length;if(0===count)throw{message:"no galeTable has instantied in the view"};if(count>1)throw{message:"when you have more than 1 galetable in view, you must send the uniqueID"};identifier=function(){for(var id in components)return id}()}var component=components[identifier];if(!component)throw{message:"no galeTable has found with id {0}".format([identifier])};return component};return self.getRegisteredTables=function(){return components},self.endpoint=function(value,uniqueID){return _getByHandle(uniqueID).endpoint(value)},self.setup=function(endpoint,cfg,uniqueID){return _getByHandle(uniqueID).setup(endpoint,cfg)},self.$on=function(eventName,callback,uniqueID){var component=_getByHandle(uniqueID);component.$on(eventName,callback)},deferred.promise.$$register=$$register,deferred.promise.$$unregister=$$unregister,$rootScope.$on("$viewContentLoaded",function(){deferred.resolve(self)}),deferred.promise}),angular.module("gale.directives").directive("selectTextOnClick",function(){return{restrict:"A",link:function(scope,element){element.on("click",function(){this.select()})}}}),angular.module("gale.directives").directive("toNumberOnBlur",function($filter){return{require:"ngModel",restrict:"A",link:function(scope,elm,attrs,ctrl){var isReadonly=attrs.readonly;elm.bind("blur",function(){var filter="number";ctrl.$viewValue=$filter(filter)(ctrl.$modelValue),ctrl.$render()}),elm.bind("focus",function(){isReadonly||(ctrl.$viewValue=ctrl.$modelValue,ctrl.$render())}),scope.$watch("ctrl.$modelValue",function(){elm.triggerHandler("blur")})}}}),angular.module("gale.directives").directive("ngEmail",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ctrl){var pattern=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;ctrl.$validators.email=function(modelValue,viewValue){return ctrl.$isEmpty(modelValue)?!0:ctrl.$isEmpty(viewValue)?!1:pattern.test(viewValue)}}}}),angular.module("gale.directives").directive("ngRange",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ctrl){var min=parseInt(attrs.min),max=parseInt(attrs.max);ctrl.$validators.range=function(modelValue,viewValue){var value=parseInt(viewValue);return ctrl.$isEmpty(modelValue)?!0:ctrl.$isEmpty(viewValue)?!1:isNaN(min)||isNaN(max)?isNaN(min)?isNaN(max)?!0:max>=value?!0:!1:value>=min?!0:!1:value>=min&&max>=value?!0:!1}}}}),angular.module("gale.directives").directive("ngRut",function(){return{restrict:"A",require:"ngModel",link:function(scope,elem,attr,ctrl){var validaRut=function(rutCompleto){var tmp=[];if(rutCompleto.indexOf("-")>0){if(!/^[0-9]+-[0-9kK]{1}$/.test(rutCompleto))return!1;tmp=rutCompleto.split("-")}else{var rut=rutCompleto.replace("-","");tmp.push(rut.substring(0,rut.length-1)),tmp.push(rut.substring(rut.length-1))}return tmp.length<2?!1:dv(tmp[0])+""==tmp[1].toLowerCase()+""},dv=function(T){for(var M=0,S=1;T;T=Math.floor(T/10))S=(S+T%10*(9-M++%6))%11;return S?S-1:"k"};ctrl.$validators.rut=function(modelValue,viewValue){return ctrl.$isEmpty(modelValue)?!0:ctrl.$isEmpty(viewValue)?!1:validaRut(viewValue)?!0:!1}}}}),angular.module("gale.filters").filter("capitalize",function(){return function(input){return input?input.replace(/([^\W_]+[^\s-]*) */g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()}):""}}),angular.module("gale.filters").filter("localize",function($Localization,$log,$interpolate){return function(text,parameters){try{var template=$Localization.get(text);if(parameters){var exp=$interpolate(template);template=exp({parameters:parameters})}return template}catch(e){return text}}}),function(){angular.module("gale.filters").filter("restricted",function($Api,Identity){return function(resourceUrl){return resourceUrl(resourceUrl,Identity)}})}(),angular.module("gale.filters").filter("template",function($log,$interpolate){return function(template,context){var exp=$interpolate(template),content=exp(context);return content}}),angular.module("gale.services.configuration").service("$Configuration",function($rootScope,$LocalStorage,CONFIGURATION){function get(name,defaultValue){var v=_values[name];if(void 0===typeof v){if(defaultValue)return defaultValue;throw Error(name+" don't exists in configuration")}return _values[name]}function exists(name){return null!=_values[name]}function set(name,value){_values[name]=value}var _values={};for(var env_name in CONFIGURATION)set(env_name,CONFIGURATION[env_name]);return{get:get,exists:exists}}),angular.module("gale.services.configuration").service("$Localization",function(RESOURCES){function get(name,defaultValue){var v=RESOURCES[name];if("undefined"==typeof v){ns=name.split("."),index=RESOURCES;for(var n in ns)void 0!==index[ns[n]]?(index=index[ns[n]],error=!1):error=!0;if(error){if(defaultValue)return defaultValue;throw Error(name+" don't exists in resources")}return index}return RESOURCES[name]}function exists(name){return null!=RESOURCES[name]}return{get:get,exists:exists}}),angular.module("gale.services").provider("$Api",function(){var _endpoint=null,EVENTS={BEFORE_SEND:"before-send",SUCCESS:"success",ERROR:"error"};this.setEndpoint=function(endpoint){_endpoint=endpoint},this.$get=function($rootScope,$http,$log,KQLBuilder){var self=this,$$listeners={};self.$on=function(name,listener){var namedListeners=$$listeners[name];return namedListeners||($$listeners[name]=namedListeners=[]),namedListeners.push(listener),function(){namedListeners[indexOf(namedListeners,listener)]=null}};var fire=function(name,args){var listeners=$$listeners[name];listeners&&angular.forEach(listeners,function(listener){listener.apply(listener,args)})};return self.getEndpoint=function(){if(!_endpoint)throw Error("ENDPOINT_NOT_CONFIGURED");return _endpoint},self.invoke=function(method,url,body,headers){var _headers={"Content-Type":"application/json"};if(headers)for(var name in headers)_headers[name]=headers[name];fire(EVENTS.BEFORE_SEND,[_headers,url,body]);var cfg={url:self.getEndpoint()+url,method:method,headers:_headers};cfg["GET"===method?"params":"data"]=body,$log.debug("["+method+" "+url+"] parameters: ",body);var http=$http(cfg).success(function(data,status,headers){fire(EVENTS.SUCCESS,[data,status,headers])}).error(function(data,status,headers){fire(EVENTS.ERROR,[data,status,headers])});return http},self.create=function(url,body,headers){return self.invoke("POST",url,body,headers)},self.kql=function(url,kql,headers){return url=KQLBuilder.build(url,kql),self.invoke("GET",url,{},headers)},self.read=function(url,parameters,headers){return self.invoke("GET",url,parameters,headers)},self.update=function(url,id,body,headers){return url+="/{0}".format([id]),self.invoke("PUT",url,body,headers)},self["delete"]=function(url,id,headers){return url+="/{0}".format([id]),self.invoke("DELETE",url,{},headers)},self}}),angular.module("gale.services").factory("KQLBuilder",function(){var self=this;return self.build=function(endpoint,configuration){var arr=[],builder=[endpoint+"?"];configuration.select&&(builder.push("$select="),arr=[],angular.forEach(function(key){arr.push(key)}),builder.push(arr.join(",")),builder.push("&")),configuration.filters&&(builder.push("$filter="),arr=[],angular.forEach(configuration.filters,function(item){arr.push(item.property+" "+item.operator+" '"+item.value+"'")}),builder.push(arr.join(",")),builder.push("&")),configuration.limit&&(builder.push("$limit="),builder.push(configuration.limit),builder.push("&")),configuration.orderBy&&(builder.push("$orderBy="),builder.push(configuration.orderBy.property),builder.push(" "),builder.push(configuration.orderBy.order),builder.push("&"));var url=builder.join("");return url},this}),function(){angular.module("gale.services").run(function(){}).provider("$Identity",function(){function getIssuerEndpoint(){if(!_issuerEndpoint)throw Error("ISSUER_ENDPOINT_NOT_SET");return _issuerEndpoint}function getLogInRoute(){if(!_logInRoute)throw Error("LOGINURL_NOT_SET");return _logInRoute}var $this=this,AUTH_EVENTS={loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"},_issuerEndpoint=null,_logInRoute=null,_enable=!1,_whiteListResolver=function(){return!0};$this.setIssuerEndpoint=function(value){return _issuerEndpoint=value,$this},$this.setLogInRoute=function(value){return _logInRoute=value,$this},$this.enable=function(){return _enable=!0,$this},$this.setWhiteListResolver=function(value){if("function"!=typeof value)throw Error("WHITELIST_RESOLVER_FUNCTION_EXPECTED");return _whiteListResolver=value,$this},$this.$get=function($rootScope,$Api,$state,$LocalStorage){var _token_key="$_identity",_properties={},_authResponse=$LocalStorage.getObject(_token_key),self=this,_login=function(oauthToken){$LocalStorage.setObject(_token_key,oauthToken),_authResponse=oauthToken,$rootScope.$broadcast(AUTH_EVENTS.loginSuccess,oauthToken)},_logout=function(){$LocalStorage.remove(_token_key),_authResponse=null,$rootScope.$broadcast(AUTH_EVENTS.logoutSuccess),$state.go(getLogInRoute())},_addProperty=function(name,value){_properties[name]=value};return self.authenticate=function(credentials){return $Api.invoke("POST",getIssuerEndpoint(),credentials).success(function(data){_login(data)}).error(function(){$rootScope.$broadcast(AUTH_EVENTS.loginFailed)})},self.extend=function(name,value){if("object"!=typeof name)_addProperty(name,value);else for(var key in name)_addProperty(key,name[key])},self.getAccessToken=function(){return _authResponse.access_token},self.logOut=function(){_logout()},self.getCurrent=function(){var payload=self.getAccessToken().split(".")[1];if(!atob)throw Error("ATOB_NOT_IMPLEMENTED");return data=decodeURIComponent(escape(atob(payload))),data=JSON.parse(data),data.property=function(name){return _properties[name]},data.isInRole=function(roleName){return _.contains(data.role,roleName)},data},self.isAuthenticated=function(){return null!==_authResponse},_enable&&($Api.$on("before-send",function(headers){if(self.isAuthenticated()){var jwt=_authResponse;headers.Authorization=jwt.token_type+" "+jwt.access_token}}),$Api.$on("error",function(data,status){var _event=null;switch(status){case 401:return void _logout();case 403:_event=AUTH_EVENTS.notAuthorized;break;case 419:case 440:_event=AUTH_EVENTS.sessionTimeout}_event&&$rootScope.$broadcast(_event,data,status)}),$rootScope.$on("$stateChangeStart",function(event,toState,current){self.isAuthenticated()||toState.name===getLogInRoute()||_whiteListResolver(toState,current)||($state.go(getLogInRoute()),event.preventDefault())})),self}})}(),angular.module("gale.services").factory("$LocalStorage",function($window){return{set:function(key,value){$window.localStorage[key]=value},get:function(key,defaultValue){return $window.localStorage[key]||defaultValue},setObject:function(key,value){$window.localStorage[key]=angular.toJson(value)},getObject:function(key){return angular.fromJson($window.localStorage[key]||null)},remove:function(key){$window.localStorage.removeItem(key)},clear:function(){$window.localStorage.clear()},exists:function(){return null!=$window.localStorage[key]}}}),angular.module("gale.services").factory("$Timer",function($timeout){function Timer(callback,duration,invokeApply){this._callback=callback,this._duration=duration||0,this._invokeApply=invokeApply!==!1,this._timer=null}function timerFactory(callback,duration,invokeApply){return new Timer(callback,duration,invokeApply)}return Timer.prototype={constructor:Timer,isActive:function(){return!!this._timer},restart:function(){this.stop(),this.start()},flush:function(){this._resolveFunction&&this._resolveFunction()},start:function(){var self=this;self._timer&&self.stop(),this._timer=$timeout(function(){try{self._callback.call(null)}finally{self._timer=null}},this._duration,this._invokeApply)},stop:function(){$timeout.cancel(this._timer),this._timer=!1},destroy:function(){this.stop(),this._callback=null,this._duration=null,this._invokeApply=null,this._timer=null}},timerFactory.Timer=Timer,timerFactory});
//# sourceMappingURL=angular-gale.min.js.map